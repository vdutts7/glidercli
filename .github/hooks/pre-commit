#!/bin/bash
# Blocks commits if email not in allowed list (reads from repo.config.json)
# If allowed_emails is empty, skip check (user hasn't configured yet)

ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
CONFIG="$ROOT/repo.config.json"
EMAIL=$(git config user.email)

# Read allowed emails from config
if [[ -f "$CONFIG" ]] && command -v jq &>/dev/null; then
    ALLOWED=$(jq -r '.allowed_emails[]' "$CONFIG" 2>/dev/null)
else
    # No config or jq - skip check
    exit 0
fi

# If no emails configured, skip check
[[ -z "$ALLOWED" ]] && exit 0

echo "$ALLOWED" | grep -qx "$EMAIL" && exit 0

echo ""
echo "‚ùå BLOCKED: $EMAIL not allowed"
echo ""
echo "Allowed emails (from repo.config.json):"
echo "$ALLOWED" | sed 's/^/  /'
echo ""
echo "Fix: git config user.email '<one of the above>'"
echo ""
exit 1
